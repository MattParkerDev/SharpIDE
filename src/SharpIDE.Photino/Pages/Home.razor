@page "/"
@using Microsoft.Build.Construction
@using Microsoft.Build.Evaluation
@using Microsoft.Build.Execution
@using Microsoft.Build.Globbing
@using Microsoft.Build.Globbing.Extensions
@using SharpIDE.Application.Features.SolutionDiscovery

<MudText>Welcome to a new Photino Blazor app!</MudText>

@if (_solutionFile is null)
{
	return;
}

<MudTreeView T="ProjectInSolution" Dense="true">
	@foreach(var project in _rootNodes)
	{
		@GetProjectFragment(project)
	}
</MudTreeView>


@code {

	private SolutionFile _solutionFile = null!;
	private List<ProjectInSolution> _rootNodes = [];
	private Dictionary<string, List<Folder>> _folders = new();

	private RenderFragment GetProjectFragment(ProjectInSolution project) =>
		@<text>
			 <MudTreeViewItem Value="project" Text="@project.ProjectName">
				 @foreach(var child in _solutionFile.ProjectsByGuid.Values.Where(s => s.ParentProjectGuid == project.ProjectGuid).OrderBy(s => s.ProjectName))
				 {
					 @GetProjectFragment(child)
				 }
				 @GetFolderFragment(_folders.GetValueOrDefault(project.ProjectGuid, []))
			 </MudTreeViewItem>
		 </text>;

	private RenderFragment GetFolderFragment(List<Folder> folders) =>
		@<text>
			 @foreach (var folder in folders.Where(s => s.ParentFolder is null))
			 {
				 <MudTreeViewItem T="ProjectInSolution" Text="@folder.Name">
					@GetFolderFragment(folders.Where(s => s.ParentFolder == folder).ToList())
					@foreach(var file in folder.Files)
					{
					 <MudTreeViewItem T="ProjectInSolution" Text="@file.Name" />
					}
				 </MudTreeViewItem>
			 }
	</text>;

	protected override async Task OnInitializedAsync()
	{
		var solutionFile = GetNodesInSolution.ParseSolutionFileFromPath("D:/matth/Documents/Git/amazon/ClientPortal.sln");
		ArgumentNullException.ThrowIfNull(solutionFile);
		_solutionFile = solutionFile;
		var rootNodes = solutionFile.ProjectsByGuid.Values.Where(p => p.ParentProjectGuid == null).OrderBy(s => s.ProjectName).ToList();
		_rootNodes = rootNodes;

		var folders2 = _solutionFile.ProjectsByGuid.Values
			.Where(s => s.ProjectType == SolutionProjectType.KnownToBeMSBuildFormat)
			.Take(2)
			.Select(s => (s, GetNodesInSolution.GetFoldersInProject(s.AbsolutePath)))
			.ToDictionary(s => s.s.ProjectGuid, s => s.Item2);
		_folders = folders2;
	}

}
